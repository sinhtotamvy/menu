<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  <title>Sinh T·ªë T√¢m Vy</title>
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@500;700&display=swap" rel="stylesheet">
  <style>
    /* === THEME SHOPEE FOOD === */
    :root { 
      --primary-gradient: linear-gradient(135deg, #ff4b2b 0%, #ff9068 100%);
      --primary-solid: #ff5722; --bg: #f5f5f5; --white: #ffffff; --text: #333; --red: #d32f2f; --blue-fb: #1877F2;
    }
    body { font-family: 'Quicksand', sans-serif; background: #eee; margin: 0; padding: 0; display: flex; justify-content: center; min-height: 100vh; color: var(--text); -webkit-tap-highlight-color: transparent; }
    .app-container { width: 100%; max-width: 480px; background: var(--bg); min-height: 100vh; position: relative; padding-bottom: 100px; box-shadow: 0 0 25px rgba(0,0,0,0.1); }
    
    /* Header */
    .header-wrapper { background: var(--primary-gradient); padding: 15px 15px 20px 15px; position: sticky; top: 0; z-index: 90; box-shadow: 0 4px 15px rgba(255, 87, 34, 0.3); border-radius: 0 0 20px 20px; }
    .header-top { display: flex; align-items: center; margin-bottom: 15px; }
    .shop-logo { width: 50px; height: 50px; border-radius: 50%; border: 2px solid white; object-fit: cover; margin-right: 12px; background: white; }
    .header-title { color: white; margin: 0; font-size: 20px; font-weight: 800; flex: 1; }
    .search-box { position: relative; width: 100%; }
    .search-input { width: 100%; padding: 12px 15px 12px 40px; border: none; border-radius: 25px; font-size: 14px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); outline: none; }
    .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #999; }
    .status-bar { background: #333; color: white; padding: 8px; text-align: center; font-weight: bold; font-size: 12px; display: none; margin-top: -15px; z-index: 80; }
    
    /* Menu & Group (M·∫∂C ƒê·ªäNH M·ªû) */
    .menu-container { padding: 15px; padding-top: 10px; }
    .menu-group { margin-bottom: 15px; background: #fff; border-radius: 12px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
    .group-header { padding: 12px 15px; background: #fff; color: var(--primary-solid); font-weight: 800; font-size: 16px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; border-bottom: 1px solid #f0f0f0; }
    .group-header.active .arrow { transform: rotate(180deg); }
    .group-content { display: block; padding: 5px; } /* M·∫∑c ƒë·ªãnh hi·ªán (Block) */
    
    .item-card { background: #fff; border-radius: 12px; padding: 10px; display: flex; margin-bottom: 8px; border-bottom: 1px dashed #eee; align-items: center; }
    .item-card:last-child { border-bottom: none; margin-bottom: 0; }
    .item-img { width: 80px; height: 80px; border-radius: 10px; object-fit: cover; background: #f0f0f0; flex-shrink: 0; }
    .item-content { flex: 1; padding-left: 12px; display: flex; flex-direction: column; justify-content: center; min-height: 80px; }
    .item-title { font-weight: 700; font-size: 15px; margin-bottom: 4px; }
    .item-desc { font-size: 12px; color: #888; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .item-price { color: var(--primary-solid); font-weight: 800; font-size: 15px; margin-top: auto; }
    .btn-plus { background: var(--primary-gradient); color: white; border: none; width: 30px; height: 30px; border-radius: 8px; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; margin-left: auto; }

    /* Footer M·ªõi */
    .shop-footer { text-align: center; padding: 20px 20px 40px 20px; color: #666; font-size: 13px; }
    .footer-btns { display: flex; gap: 10px; justify-content: center; margin-top: 15px; }
    .f-btn { padding: 10px 20px; border-radius: 25px; font-weight: bold; text-decoration: none; font-size: 14px; display: flex; align-items: center; gap: 8px; transition: 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .fb-btn { background: #E3F2FD; color: var(--blue-fb); border: 1px solid #BBDEFB; }
    .map-btn { background: #E8F5E9; color: #2E7D32; border: 1px solid #C8E6C9; }
    
    .float-cart { position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 440px; background: #333; color: white; padding: 12px 20px; border-radius: 50px; display: flex; justify-content: space-between; align-items: center; font-weight: 700; box-shadow: 0 10px 30px rgba(0,0,0,0.3); z-index: 95; cursor: pointer; display: none; }
    
    /* Modals */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(2px); z-index: 200; display: none; justify-content: center; align-items: flex-end; }
    .modal-overlay.active { display: flex; }
    .sheet-modal { background: #fff; width: 100%; max-width: 480px; border-radius: 24px 24px 0 0; padding: 25px; max-height: 85vh; overflow-y: auto; animation: slideUp 0.3s; }
    .full-modal { position: fixed; top: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 480px; height: 100%; background: #fff; z-index: 300; display: none; overflow-y: auto; padding: 20px; box-sizing: border-box; }
    @keyframes slideUp { from {transform: translateY(100%)} to {transform: translateY(0)}}

    input, select, textarea { width: 100%; padding: 14px; border: 1px solid #ddd; border-radius: 12px; margin-bottom: 15px; box-sizing: border-box; font-family: inherit; font-size: 15px; background: #f9f9f9; outline: none; }
    input:focus, textarea:focus { border-color: var(--primary-solid); background: #fff; }
    .btn-main { width: 100%; padding: 16px; background: var(--primary-gradient); color: white; border: none; border-radius: 12px; font-weight: 700; font-size: 16px; margin-top: 10px; cursor: pointer; }
    .btn-zalo { background: #0068FF; margin-bottom: 5px; }
    .radio-row { display: flex; align-items: center; justify-content: space-between; padding: 12px 0; border-bottom: 1px dashed #eee; cursor: pointer; }
    .radio-row input { width: 20px; height: 20px; accent-color: var(--primary-solid); }
    .opt-header { font-weight: 700; font-size: 14px; color: var(--primary-solid); text-transform: uppercase; margin-bottom: 10px; display: block;}
    
    .qr-box { text-align: center; background: #FFF3E0; padding: 20px; border-radius: 16px; border: 2px solid var(--primary-solid); margin-top: 15px; display: none; }
    .qr-img { width: 200px; height: 200px; margin: 10px auto; display: block; mix-blend-mode: multiply; }
    .confirm-pay { display: flex; align-items: center; gap: 12px; margin-top: 15px; padding: 15px; background: #fff; border-radius: 12px; border: 1px solid #ddd; cursor: pointer; }
    .confirm-pay input { width: 24px; height: 24px; margin: 0; flex-shrink: 0; }
    .bill-box { background: #f9f9f9; padding: 15px; border-radius: 10px; font-family: monospace; border: 1px dashed #ccc; margin: 20px 0; text-align: left; line-height: 1.5;}
    
    #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 999; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: 0.3s; }
    .spinner { width: 40px; height: 40px; border: 4px solid #eee; border-top: 4px solid var(--primary-solid); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>

<div id="loadingOverlay"><div class="spinner"></div><p style="margin-top:10px; color:#555; font-size:12px">ƒêang t·∫£i...</p></div>

<div class="app-container">
  <div id="shopStatus" class="status-bar">‚õî QU√ÅN ƒêANG NGH·ªà</div>
  <div class="header-wrapper">
    <div class="header-top">
      <img src="" class="shop-logo" id="shopLogo" onerror="this.style.display='none'">
      <h2 class="header-title">SINH T·ªê T√ÇM VY</h2>
    </div>
    <div class="search-box">
      <span class="search-icon">üîç</span>
      <input type="text" id="searchKey" class="search-input" placeholder="B·∫°n mu·ªën ƒÉn g√¨?" onkeyup="filterMenu()">
    </div>
  </div>
  <div id="menu-list" class="menu-container"></div>
  
  <div class="shop-footer" id="footerInfo"></div>
  
  <div class="float-cart" id="cartBtn" onclick="showCheckout()"><span>üõí <span id="cartCount">0</span></span><span id="cartTotal">0ƒë</span></div>
</div>

<div class="modal-overlay" id="productModal">
  <div class="sheet-modal">
    <div style="display:flex; justify-content:space-between; margin-bottom:20px; align-items:center;">
      <h3 id="mName" style="margin:0; font-size:20px;">T√™n m√≥n</h3><span onclick="closeModal()" style="font-size:28px; cursor:pointer; color:#999;">&times;</span>
    </div>
    <div class="opt-section" id="sizeSection" style="display:none; margin-bottom:20px;"><label class="opt-header">Ch·ªçn Size</label><div id="sizeOptions"></div></div>
    
    <div id="drinkOptions">
      <div class="opt-section" style="margin-bottom:20px;">
        <label class="opt-header">ƒê·ªô ng·ªçt</label>
        <select id="mSugar"><option value="">B√¨nh th∆∞·ªùng</option><option value="√çt ng·ªçt">√çt ng·ªçt</option><option value="Kh√¥ng ng·ªçt">Kh√¥ng ng·ªçt</option></select>
        <div id="iceArea" style="margin-top:15px">
          <label class="opt-header">L∆∞·ª£ng ƒë√°</label>
          <select id="mIce"><option value="">B√¨nh th∆∞·ªùng</option><option value="√çt ƒë√°">√çt ƒë√°</option><option value="ƒê√° ri√™ng">ƒê√° ri√™ng</option></select>
        </div>
      </div>
      <div class="opt-section" style="margin-bottom:20px;" id="toppingSection"><label class="opt-header">Topping</label><div id="toppingList"></div></div>
    </div>

    <div id="foodNoteSection" style="display:none; margin-bottom:20px;">
      <label class="opt-header">Ghi ch√∫ cho m√≥n n√†y</label>
      <textarea id="mItemNote" rows="2" placeholder="VD: L·∫•y nhi·ªÅu t∆∞∆°ng ·ªõt, kh√¥ng h√†nh..."></textarea>
    </div>

    <button class="btn-main" onclick="addToCart()">Th√™m v√†o gi·ªè - <span id="mPriceBtn">0ƒë</span></button>
  </div>
</div>

<div class="full-modal" id="checkoutPage">
  <div style="padding:10px 0 20px 0; display:flex; justify-content:space-between; align-items:center;">
    <h3 style="margin:0;">üì¶ X√°c nh·∫≠n</h3><span onclick="closeCheckout()" style="font-size:28px; cursor:pointer; color:#999;">&times;</span>
  </div>
  <div id="cartItemsList" style="background:#f9f9f9; padding:15px; border-radius:12px; border:1px solid #eee;"></div>
  
  <h4 style="margin:20px 0 10px 5px; color:#555;">Th√¥ng tin</h4>
  <input type="text" id="cName" placeholder="T√™n c·ªßa b·∫°n"><input type="tel" id="cPhone" placeholder="S·ªë ƒëi·ªán tho·∫°i"><input type="text" id="cAddress" placeholder="ƒê·ªãa ch·ªâ giao h√†ng"><textarea id="cNote" rows="2" placeholder="L·ªùi nh·∫Øn chung cho ƒë∆°n h√†ng..."></textarea><input type="text" id="honeypot" style="display:none">
  
  <h4 style="margin:10px 0 10px 5px; color:#555;">Thanh to√°n</h4>
  <select id="cPayment" onchange="togglePayment()"><option value="COD">üíµ Ti·ªÅn m·∫∑t</option><option value="CK">üè¶ Chuy·ªÉn kho·∫£n (QR)</option><option value="ZALO">üí¨ G·ª≠i qua Zalo</option></select>
  
  <div class="qr-box" id="qrArea">
    <div style="font-weight:bold; color:var(--primary-solid); font-size:16px;">QU√âT M√É QR</div>
    <div style="font-size:13px; color:#666; margin:8px 0; background:#fff; padding:5px; border-radius:5px;">üí° Nh·∫•n gi·ªØ QR ƒë·ªÉ l∆∞u ·∫£nh</div>
    <div style="font-size:13px; margin-bottom:5px;">N·ªôi dung: <strong id="qrContent"></strong></div>
    <img src="" id="qrImage" class="qr-img">
    <div style="font-size:16px; margin-top:10px;">S·ªë ti·ªÅn: <strong id="qrAmount" style="color:var(--red);"></strong></div>
    <div style="margin-top:8px; border-top:1px dashed #ccc; padding-top:8px;">
      <div style="font-size:12px; color:#555;">Ch·ªß t√†i kho·∫£n:</div>
      <div style="font-weight:bold; color:#000; font-size:14px; text-transform: uppercase;" id="bankOwnerName"></div>
    </div>
  </div>

  <label class="confirm-pay" id="confirmPayBox"><input type="checkbox" id="ckConfirm" onchange="checkConfirm()"><span>T√¥i ƒë√£ chuy·ªÉn kho·∫£n th√†nh c√¥ng</span></label>

  <div id="btnGroup"><button class="btn-main" id="btnOrder" onclick="submitOrder()">ƒê·∫∂T H√ÄNG NGAY</button></div>
  <div id="zaloGroup" style="display:none; text-align:center">
    <button class="btn-main btn-zalo" onclick="sendToZalo()">üìã SAO CH√âP & M·ªû ZALO</button>
    <div style="font-size:13px; color:#0068FF; margin-top:5px;">(B·∫•m n√∫t tr√™n ƒë·ªÉ Copy, sau ƒë√≥ <b>D√ÅN</b> v√†o √¥ chat Zalo)</div>
  </div>
  <div style="height:50px;"></div>
</div>

<div class="full-modal" id="successPage" style="background:white; text-align:center;">
  <div style="padding-top:40px;">
    <div style="font-size:60px;">‚úÖ</div><h2 style="color:var(--primary-solid); margin:0;">TH√ÄNH C√îNG!</h2>
    <div class="bill-box" id="billContent"></div>
    <button class="btn-main" onclick="location.reload()">V·ªÄ TRANG CH·ª¶</button>
  </div>
</div>

<script>
  // === C·∫§U H√åNH (LU D√ÅN LINK FACEBOOK V√ÄO D√íNG D∆Ø·ªöI) ===
  const FACEBOOK_URL = "https://www.facebook.com/profile.php?id=100066925050922"; 
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzGxPAoxdj1E2ymMznZza5T61Zc20z3wZdzXPBFuJTb7-IAvsbxlGEdKEXCoY3LR3Uu7w/exec";
  const LOGO_URL = "https://storage.googleapis.com/menu-tamvy/IMG_0891.png"; 
  const BANK_ID = "ACB"; const BANK_ACC = "48031187"; const BANK_NAME = "HO KINH DOANH SINH TO TAM VY"; const ZALO_PHONE = "0775826565";
  
  // C√°c nh√≥m ·∫©n ƒê√° (Sinh t·ªë/ƒê√° xay)
  const BLENDED_GROUPS = ["Sinh t·ªë", "ƒê√° xay", "Sinh to", "Da xay", "Yogurt"]; 
  
  // C√°c nh√≥m l√† M√≥n ƒÇn (·∫®n h·∫øt ƒë∆∞·ªùng ƒë√°, hi·ªán ghi ch√∫)
  const FOOD_GROUPS = ["M√≥n ƒÉn - B√°nh", "M√≥n ƒÉn", "B√°nh", "ƒÇn v·∫∑t", "Mon an"];
  
  // T√äN B·ªò NH·ªö ƒê·ªÜM (ƒê·ªîI T√äN ƒê·ªÇ FIX L·ªñI QUAY V√íNG CHO KH√ÅCH C≈®)
  const CACHE_KEY = 'TAMVY_MENU_V16'; 
  // =================

  let APP_DATA = {}, CART = [], currentItem = null, IS_OPEN = true, CURRENT_ORDER_ID = "";

  window.onload = function() {
    if(LOGO_URL) document.getElementById('shopLogo').src = LOGO_URL;
    
    // T·∫£i t·ª´ Cache m·ªõi
    const cached = localStorage.getItem(CACHE_KEY);
    if (cached) { try { const data = JSON.parse(cached); initApp(data); document.getElementById('loadingOverlay').style.display = 'none'; } catch(e) {} }
    
    // T·∫£i t·ª´ Server
    fetch(SCRIPT_URL + "?action=getMenu").then(res => res.json()).then(data => { 
      localStorage.setItem(CACHE_KEY, JSON.stringify(data));
      if (!cached) { initApp(data); document.getElementById('loadingOverlay').style.display = 'none'; }
    }).catch(err => { if(!cached) alert("L·ªói m·∫°ng! H√£y t·∫£i l·∫°i trang."); });
  };

  function initApp(data) { APP_DATA = data; checkStatus(data.shopConfig); renderMenu(); renderFooter(data.shopConfig); }
  function checkStatus(cfg) { if(!cfg.isOpen){ IS_OPEN=false; document.getElementById('shopStatus').innerText="‚õî "+cfg.msg; document.getElementById('shopStatus').style.display='block'; } }
  
  function renderMenu() {
    const container = document.getElementById('menu-list'); container.innerHTML = "";
    const groups = [...new Set(APP_DATA.menu.map(item => item.group || 'Kh√°c'))];
    groups.forEach((groupName, index) => {
      const items = APP_DATA.menu.filter(item => (item.group || 'Kh√°c') === groupName);
      if(items.length === 0) return;
      const groupDiv = document.createElement('div'); groupDiv.className = 'menu-group';
      // M·∫∂C ƒê·ªäNH M·ªû H·∫æT (active & block)
      groupDiv.innerHTML = `<div class="group-header active" onclick="toggleGroup(this)"><span>${groupName} (${items.length})</span><span class="arrow">‚ñº</span></div><div class="group-content" style="display: block;"></div>`;
      container.appendChild(groupDiv);
      const contentDiv = groupDiv.querySelector('.group-content');
      items.forEach(item => {
        let itemDiv = document.createElement('div'); itemDiv.className = 'item-card'; itemDiv.setAttribute('data-name', removeAccents(item.name.toLowerCase()));
        const btn = IS_OPEN ? `<button class="btn-plus" onclick="openItem('${item.id}')">+</button>` : ``;
        itemDiv.innerHTML = `<img src="${item.img}" class="item-img" onerror="this.src='https://via.placeholder.com/90'"><div class="item-content"><div><div class="item-title">${item.name}</div><div class="item-desc">${item.desc||''}</div></div><div style="display:flex; justify-content:space-between; align-items:center; margin-top:auto"><div class="item-price">${fmt(item.price)}</div>${btn}</div></div>`;
        contentDiv.appendChild(itemDiv);
      });
    });
  }

  function filterMenu() {
    const key = removeAccents(document.getElementById('searchKey').value.toLowerCase());
    document.querySelectorAll('.menu-group').forEach(group => {
      let hasVisibleItem = false;
      group.querySelectorAll('.item-card').forEach(item => {
        if (item.getAttribute('data-name').includes(key)) { item.style.display = 'flex'; hasVisibleItem = true; } else { item.style.display = 'none'; }
      });
      if (hasVisibleItem) { group.style.display = 'block'; } else { group.style.display = 'none'; }
    });
  }
  function removeAccents(str) { return str.normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/ƒë/g, 'd').replace(/ƒê/g, 'D'); }
  function toggleGroup(header) { const content = header.nextElementSibling; if (content.style.display === 'none') { content.style.display = 'block'; header.classList.add('active'); } else { content.style.display = 'none'; header.classList.remove('active'); } }
  
  // === FOOTER M·ªöI (FB + MAP) ===
  function renderFooter(cfg) { 
    document.getElementById('footerInfo').innerHTML = `
      <div style="margin-bottom:10px; font-weight:bold">${cfg.address}</div>
      <div style="margin-bottom:15px">üïí ${cfg.openHour}h - ${cfg.closeHour}h</div>
      <div class="footer-btns">
        <a href="${FACEBOOK_URL}" target="_blank" class="f-btn fb-btn">üîµ Facebook</a>
        <a href="${cfg.mapLink}" target="_blank" class="f-btn map-btn">üìç Google Map</a>
      </div>
    `; 
  }

  function openItem(id) {
    currentItem = APP_DATA.menu.find(i => i.id === id); document.getElementById('mName').innerText = currentItem.name;
    const sizeOpt = document.getElementById('sizeOptions'); sizeOpt.innerHTML = "";
    let html = `<label class="radio-row"><span><input type="radio" name="size" value="Size Chu·∫©n|0" checked onchange="calcPrice()"> Size Chu·∫©n</span> <span>+0ƒë</span></label>`;
    if(currentItem.sizes?.length) { document.getElementById('sizeSection').style.display='block'; currentItem.sizes.forEach(s => html += `<label class="radio-row"><span><input type="radio" name="size" value="${s.name}|${s.priceAdd}" onchange="calcPrice()"> ${s.name}</span> <span>+${fmt(s.priceAdd)}</span></label>`); } else { document.getElementById('sizeSection').style.display='none'; }
    sizeOpt.innerHTML = html;
    
    // Reset inputs
    document.getElementById('mSugar').value = ""; document.getElementById('mIce').value = ""; document.getElementById('mItemNote').value = "";

    const groupName = currentItem.group || "";
    const drinkOptions = document.getElementById('drinkOptions');
    const foodNoteSection = document.getElementById('foodNoteSection');
    const iceArea = document.getElementById('iceArea');

    // === LOGIC PH√ÇN LO·∫†I M√ìN ƒÇN / N∆Ø·ªöC U·ªêNG ===
    const isFood = FOOD_GROUPS.some(g => groupName.toLowerCase().includes(g.toLowerCase()));
    
    if (isFood) {
      // L√† M√≥n ƒÉn: ·∫®n Options, Hi·ªán Note
      drinkOptions.style.display = 'none';
      foodNoteSection.style.display = 'block';
    } else {
      // L√† N∆∞·ªõc: Hi·ªán Options, ·∫®n Note
      drinkOptions.style.display = 'block';
      foodNoteSection.style.display = 'none';

      // ·∫®n ƒê√° cho Sinh t·ªë
      if (BLENDED_GROUPS.some(g => groupName.toLowerCase().includes(g.toLowerCase()))) { 
        iceArea.style.display = 'none'; 
      } else { 
        iceArea.style.display = 'block'; 
      }
    }
    
    const topList = document.getElementById('toppingList'); topList.innerHTML = "";
    APP_DATA.toppings.forEach((tp,idx) => topList.innerHTML += `<label class="radio-row"><span><input type="checkbox" class="tp-check" value="${idx}" onchange="calcPrice()"> ${tp.name}</span> <span>+${fmt(tp.price)}</span></label>`);
    calcPrice(); document.getElementById('productModal').classList.add('active');
  }

  function calcPrice() {
    let base = currentItem.price + parseInt(document.querySelector('input[name="size"]:checked').value.split('|')[1]);
    document.querySelectorAll('.tp-check:checked').forEach(c => base += APP_DATA.toppings[c.value].price);
    document.getElementById('mPriceBtn').innerText = fmt(base); return base;
  }
  function closeModal() { document.getElementById('productModal').classList.remove('active'); }
  
  function addToCart() {
    const sizeVal = document.querySelector('input[name="size"]:checked').value.split('|');
    let toppings = []; 
    let iceVal = ""; 
    let sugarVal = "";
    let itemNote = "";

    const groupName = currentItem.group || "";
    const isFood = FOOD_GROUPS.some(g => groupName.toLowerCase().includes(g.toLowerCase()));

    if (isFood) {
      itemNote = document.getElementById('mItemNote').value; // L·∫•y ghi ch√∫ m√≥n ƒÉn
    } else {
      document.querySelectorAll('.tp-check:checked').forEach(c => toppings.push(APP_DATA.toppings[c.value].name));
      iceVal = document.getElementById('iceArea').style.display === 'none' ? "" : document.getElementById('mIce').value;
      sugarVal = document.getElementById('mSugar').value;
    }

    CART.push({ 
      name: currentItem.name, final: calcPrice(), size: sizeVal[0], 
      sugar: sugarVal, ice: iceVal, toppings: toppings, note: itemNote 
    });
    updateCartUI(); closeModal();
  }
  function updateCartUI() {
    const total = CART.reduce((sum,i)=>sum+i.final,0);
    document.getElementById('cartCount').innerText = CART.length; document.getElementById('cartTotal').innerText = fmt(total);
    document.getElementById('cartBtn').style.display = CART.length ? 'flex' : 'none';
  }

  function showCheckout() {
    if(!CART.length) return;
    CURRENT_ORDER_ID = "DH" + Math.floor(10000 + Math.random() * 90000);
    const list = document.getElementById('cartItemsList'); list.innerHTML = "";
    CART.forEach((item,idx) => {
        let opts = []; 
        if(item.size && !item.size.includes('Chu·∫©n')) opts.push(item.size);
        
        // Hi·ªÉn th·ªã kh√°c nhau tu·ª≥ l√† M√≥n hay N∆∞·ªõc
        if (item.note) {
           opts.push(`"${item.note}"`);
        } else {
           if(item.sugar) opts.push(item.sugar);
           if(item.ice) opts.push(item.ice);
           if(item.toppings.length) opts.push(item.toppings.join('+'));
        }
        
        let optString = opts.length ? `(${opts.join(', ')})` : '';
        list.innerHTML += `<div style="display:flex;justify-content:space-between;margin-bottom:10px;border-bottom:1px dashed #eee;padding-bottom:5px"><div><b>${item.name}</b> <small>${optString}</small></div><div style="text-align:right"><div>${fmt(item.final)}</div><a href="#" onclick="removeCart(${idx})" style="color:red;font-size:12px">X√≥a</a></div></div>`;
    });
    document.getElementById('checkoutPage').style.display='block'; togglePayment();
  }
  function closeCheckout() { document.getElementById('checkoutPage').style.display='none'; }
  function removeCart(idx) { CART.splice(idx,1); updateCartUI(); if(!CART.length) closeCheckout(); else showCheckout(); }

  function togglePayment() {
    const m = document.getElementById('cPayment').value; const total = CART.reduce((sum,i)=>sum+i.final,0); const phone = document.getElementById('cPhone').value;
    document.getElementById('btnGroup').style.display = (m==='ZALO')?'none':'block'; document.getElementById('zaloGroup').style.display = (m==='ZALO')?'block':'none';
    if(m==='CK') {
      document.getElementById('qrArea').style.display='block'; document.getElementById('confirmPayBox').style.display='flex';
      document.getElementById('qrAmount').innerText = fmt(total); document.getElementById('bankOwnerName').innerText = BANK_NAME;
      const content = "TT " + CURRENT_ORDER_ID + " " + phone; document.getElementById('qrContent').innerText = content;
      document.getElementById('qrImage').src = `https://img.vietqr.io/image/${BANK_ID}-${BANK_ACC}-compact.jpg?amount=${total}&addInfo=${encodeURIComponent(content)}&accountName=${encodeURIComponent(BANK_NAME)}`;
      document.getElementById('btnOrder').disabled = true; document.getElementById('ckConfirm').checked = false;
    } else { document.getElementById('qrArea').style.display='none'; document.getElementById('confirmPayBox').style.display='none'; document.getElementById('btnOrder').disabled = false; }
  }
  document.getElementById('cPhone').addEventListener('input', togglePayment);
  function checkConfirm() { document.getElementById('btnOrder').disabled = !document.getElementById('ckConfirm').checked; }

  function submitOrder() {
    const name = document.getElementById('cName').value, phone = document.getElementById('cPhone').value, addr = document.getElementById('cAddress').value;
    if(!name || !phone || !addr) return alert("Thi·∫øu th√¥ng tin!");
    document.getElementById('btnOrder').innerText = "ƒêANG G·ª¨I..."; document.getElementById('btnOrder').disabled = true;
    const total = CART.reduce((sum,i)=>sum+i.final,0);
    const details = CART.map(i => {
        let opts = []; 
        if(i.size && !i.size.includes('Chu·∫©n')) opts.push(i.size);
        if (i.note) {
           opts.push(`"${i.note}"`);
        } else {
           if(i.sugar) opts.push(i.sugar);
           if(i.ice) opts.push(i.ice);
           if(i.toppings.length) opts.push(i.toppings.join('+'));
        }
        return `- ${i.name} (${opts.join(', ')})`;
    }).join('\n');
    const orderData = { orderId: CURRENT_ORDER_ID, name: name, phone: phone, address: addr, note: document.getElementById('cNote').value, paymentMethod: document.getElementById('cPayment').value, details: details, total: total, honey: document.getElementById('honeypot').value };
    fetch(SCRIPT_URL + "?action=submitOrder", { method: "POST", body: JSON.stringify(orderData) }).then(res => res.json()).then(res => {
      if(res.success) {
        document.getElementById('checkoutPage').style.display = 'none'; document.getElementById('successPage').style.display = 'block';
        document.getElementById('billContent').innerHTML = `M√É: ${CURRENT_ORDER_ID}<br>KH: ${name}<br>ƒê/C: ${addr}<br>----------------<br>${details.replace(/\n/g,'<br>')}<br>----------------<br>T·ªîNG: ${fmt(total)}`;
        CART=[];
      } else { alert("L·ªói: "+res.msg); document.getElementById('btnOrder').disabled=false; }
    }).catch(err => { alert("L·ªói m·∫°ng! Vui l√≤ng th·ª≠ l·∫°i."); document.getElementById('btnOrder').disabled=false; });
  }

  function sendToZalo() {
    const total = CART.reduce((sum,i)=>sum+i.final,0); let msg = `ü•ë ƒê∆†N M·ªöI\n`; 
    CART.forEach(i=>{
        let opts = []; 
        if(i.size && !i.size.includes('Chu·∫©n')) opts.push(i.size);
        if (i.note) {
           opts.push(`"${i.note}"`);
        } else {
           if(i.sugar) opts.push(i.sugar);
           if(i.ice) opts.push(i.ice);
           if(i.toppings.length) opts.push(i.toppings.join('+'));
        }
        msg+=`‚ñ™ ${i.name} (${opts.join(', ')})\n`;
    }); 
    msg+=`üí∞ ${fmt(total)}\nüë§ ${document.getElementById('cName').value} - ${document.getElementById('cPhone').value}\nüìç ${document.getElementById('cAddress').value}`;
    navigator.clipboard.writeText(msg).then(() => { alert("ƒê√£ COPY! ƒêang m·ªü Zalo..."); window.open(`https://zalo.me/${ZALO_PHONE}`); }).catch(() => alert("L·ªói copy."));
  }

  function fmt(n) { return n.toLocaleString('vi-VN') + 'ƒë'; }
</script>
</body>
</html>